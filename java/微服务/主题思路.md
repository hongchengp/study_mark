# 为什么要微服务

传统项目中，都是聚合项目

比如一个项目，有招标、设计、采购三个模块

我们直接用一个大项目，将三个模块聚合起来

但微服务不是

它是将模块尽量的细化

让每个模块都是可以独立运行（接口隔离原则，高内聚，低耦合）



问题来了，模块间的调用怎么办

用网络请求

就是和前端一样，用的http地址

但是如果ip变了怎么办，硬编码不好

用一个中间层

它和dns很像（有服务名和ip的映射关系）

我们直接调用它的接口就可以（rpc实现，网络请求和调用接口一样）

这个就是**注册和发现中心**







## 网络请求

restTemplate，但是它是用的硬编码

路径 & 请求方法 & 参数 & returnType



## 注册和发现中心nacos

将服务名和ip有映射关系

中间层，用它可以实现网络请求的调用

引入nacos依赖

引入配置文件

服务端和消费端都要

因为它既可以是服务也可以是消费

而且要给出自己的服务名（根据这个来映射ip+port，注册的时候都是用网络的，自己的ip不用给出）



## Feign

它是将网络请求 变得和接口调用一样（rpc）

我们不用知道它底层的实现

那我们是要知道它的接口

但是它的接口本来就暴露了啊

它和代理模式一样，**feign给的接口应该和其他服务的接口一样**

直接掉用 Feign注解类的方法就可以

而 Feign的方法 就可以 其他 controller 方法的 声明（不用自己定义）



## Ribbon

它是负载均衡

集群中用的



## 微服务网关（gateway）

提供api接口的（api到ip的映射）

实际上是路由的功能

它具体到api接口的管理了





### 前端调用

我们可以用feign，调用接口

但是前端还是要ip的，集群很多，不知道调用那个，so直接访问gateway的方法 then gateway 拉取 nacos，负载均衡到其他的微服务

但是是集群啊，不能只用一个接口啊

用微服务网关

前端调用它的接口，它可以实现接口的映射，负载均衡等等



### 其他项目调用

有些接口是不能被外部项目调用的（封装的特性）

可以用微服务网关对请求的ip进行检查

只有允许被访问的才可以访问



## 配置中心

可以实现一起配置

就是方便

还可以运行时配置

实际上用的是网络调用



## Gateway

它接受前端的请求，路由到别的微服务

它怎么路由呢，用配置文件 or 类



### 检验

如何 验证用户登录

前端将token 传入，gateway，对token验证可以则放行，else go out

但是验证后，会将（token）用户信息存入 ThreadLocal, but 微服务，不可以啊

单体是怎么解决的

用拦截器 or filter 来对进行检验

这个也可以 why， 网关的路由本质还是 http的调用，so，gateway 检验token（算法 & 密钥（这个不能给人看）），将信息

传入 http调用



其他微服务，用拦截器，将cookie信息存入 ThreadLocal，那微服务之间调用的，也是将信息存入 http（比如 数据头）

而微服务，都会拦截http，将cookie存入 ThreadLocal

而gateway 保证 http都是经过检验的





### 微服务保护



#### 请求限流

防止一种请求太多，别的请求没有

多的，直接拒绝



#### 线程隔离

防止雪崩，因为如果一种请求一直占用资源，别的请求就很难用到线程池

而且调用它的，也会因为它，一直阻塞（熔断也可以处理这个）



#### 熔断

就是如果微服务调用老是失败，就直接调用，而是执行 errorfallback





### 分布式事务

事务，就是有一个请求，有多个写

ACID

一个是，用undolog（记录的是逻辑，比如if inset then delete），它不用一直上锁，是弱一致性

一个是强一致性，直接上锁，但是效率很低



### 编写流程

#### 全局异常处理器

servlet的处理不到，因为它不是 springmvc管

有个这，就可以直接抛出异常，让异常处理器，来new 相应的信息，

（Result （data 数据, msg描述信息，code错误码标识是什么错误的）），so我们就可以直接throw 错误就可以了

其他 Result的生成就给 错误处理器做（可以复用哦）

（在javaee 中，在方法上声明这个，就是提示调用者，我会抛出这个错误，记得处理，不一定处理，也可以抛出，但是给jvm就不好了

而有些严格的异常，一定要处理）



### 错误码 & msg

我描述一个异常，应该用错误码来 标识是什么类型的错误，msg来表述详细的信息

这个可以用 自定义类来封装

而有些信息是通用的，不变的，可以用enum（枚举），枚举就是类，有get，set，construct，属性应该是 final

```java
public interface IError {
    String msg();
    Interge
}


public enum Error impliment IError {
    
}
```

